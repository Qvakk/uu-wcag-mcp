services:
  uu-wcag-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    image: uu-wcag-mcp:latest
    container_name: uu-wcag-mcp
    restart: unless-stopped
    # Use HTTP/SSE transport (runs the node server)
    # For stdio mode, use: command: ["tail", "-f", "/dev/null"]
    command: ["node", "src/index.js"]
    ports:
      - "3100:3000"  # Map container port 3000 to host port 3100
    extra_hosts:
      - "host.docker.internal:host-gateway" # Enable container to access host machine
    environment:
      # === Transport Mode ===
      # Options: 'stdio' or 'http' (SSE)
      - MCP_TRANSPORT=http
      - MCP_PORT=3000

      # === Logging ===
      - LOG_LEVEL=info

      # === Crawling Settings ===
      - MAX_DEPTH=3
      - MAX_PAGES=50
      - CRAWL_DELAY=1000

      # === pa11y Configuration ===
      - TIMEOUT=60000
      - WCAG_STANDARD=WCAG2AA
      - HEADLESS=true

      # === SPA/i18n Support ===
      # Wait 8 seconds for translations and dynamic content to load
      # Reduce to 5000 if not using i18n
      - PA11Y_WAIT=8000

      # Wait until ALL network requests complete (best for i18n/SPAs)
      # Options: load, domcontentloaded, networkidle0, networkidle2
      - PA11Y_WAIT_UNTIL=networkidle0

      # === Viewport ===
      - VIEWPORT_WIDTH=1920
      - VIEWPORT_HEIGHT=1080

      # === Report Defaults ===
      - DEFAULT_FORMAT=markdown
      - DEFAULT_LANGUAGE=no

      # === Localhost Testing ===
      - ALLOW_LOCALHOST=true
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - uu-tilsynet-network

networks:
  uu-tilsynet-network:
    driver: bridge
